<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gRPC Service Manager</title>
    <!-- Tailwind (CDN, for utility classes only; safe alongside existing CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              border: '#e5e7eb',
              input: '#e5e7eb',
              ring: '#6366f1',
              background: '#ffffff',
              foreground: '#111827',
              primary: {
                DEFAULT: '#6366f1',
                foreground: '#ffffff',
              },
              muted: {
                DEFAULT: '#f3f4f6',
                foreground: '#6b7280',
              },
              destructive: '#ef4444',
            }
          }
        }
      }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* shadcn-inspired tokens */
        :root {
            --radius: 12px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: #fff;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(99,102,241,0.15);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #7c3aed 100%);
            color: white;
            border: 1px solid rgba(99,102,241,0.6);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: 1px solid rgba(107,114,128,0.4);
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .service-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .service-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .service-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .service-fields {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        .service-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .help-text {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .example {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .example h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .example code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 90%;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1001;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.4rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 25px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .detail-item strong {
            display: block;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item span {
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            position: relative;
            margin: 15px 0;
        }

        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a5568;
        }

        .code-block-title {
            color: #a0aec0;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .copy-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .copy-btn:hover {
            background: #2d3748;
        }

        .copy-btn.copied {
            background: #48bb78;
        }

        .endpoint-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .endpoint-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .endpoint-item:last-child {
            border-bottom: none;
        }

        .endpoint-method {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 15px;
            min-width: 60px;
            text-align: center;
        }

        .endpoint-method.get { background: #48bb78; }
        .endpoint-method.post { background: #667eea; }
        .endpoint-method.put { background: #ed8936; }
        .endpoint-method.delete { background: #f56565; }

        .endpoint-path {
            font-family: 'Courier New', monospace;
            color: #333;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 gRPC Service Manager</h1>
            <p>Create and manage gRPC services with automatic REST API generation</p>
            <div class="mt-3">
                <a href="/docs" class="btn btn-secondary" style="text-decoration:none">View Docs (README)</a>
            </div>
        </div>

        <div class="content">
            <!-- Top Navigator -->
            <div class="mb-6 flex items-center justify-between">
                <div class="inline-flex rounded-lg border border-gray-200 bg-white shadow-sm overflow-hidden">
                    <button id="tab-create" class="px-4 py-2 text-sm font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-ring" onclick="setTab('create')">Create</button>
                    <button id="tab-nested" class="px-4 py-2 text-sm font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-ring border-l" onclick="setTab('nested')">Nested</button>
                    <button id="tab-rpc" class="px-4 py-2 text-sm font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-ring border-l" onclick="setTab('rpc')">RPC</button>
                    <button id="tab-existing" class="px-4 py-2 text-sm font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-ring border-l" onclick="setTab('existing')">Existing</button>
                </div>
            </div>
            <!-- Create Service Section -->
            <div class="section" data-section="create">
                <h2 class="section-title">Create New Service</h2>
                
                <div id="alert-container"></div>

                <form id="create-service-form" class="space-y-2">
                    <div class="form-group">
                        <label for="service-name">Service Name *</label>
                        <input type="text" id="service-name" name="serviceName" placeholder="e.g., User, Product, Order" required>
                        <div class="help-text">Enter the service name in PascalCase (e.g., UserService becomes User). First letter will be auto-capitalized.</div>
                    </div>

                    <div class="form-group">
                        <label for="service-fields">Service Fields *</label>
                        <textarea id="service-fields" name="serviceFields" placeholder="name:string,email:string,age:int32,active:bool" required></textarea>
                        <div class="help-text">Format: fieldName:type,fieldName:type (e.g., name:string,email:string,age:int32)</div>
                    </div>

                    <div class="example">
                        <h4>📝 Example:</h4>
                        <p><strong>Service Name:</strong> <code>User</code></p>
                        <p><strong>Fields:</strong> <code>name:string,email:string,age:int32,active:bool,created_at:google.protobuf.Timestamp</code></p>
                <p><strong>Note:</strong> Field names in snake_case (e.g., <code>avatar_url</code>) will be converted to camelCase in Go structs (e.g., <code>AvatarUrl</code>) while preserving the original format in JSON/BSON tags.</p>
                        <p>This will create a User service with CRUD operations and REST endpoints.</p>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary">✨ Create Service</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                    </div>
                </form>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Creating service...</p>
                </div>
            </div>

            <!-- Add RPC Section -->
            <div class="section" data-section="rpc" style="display:none">
                <h2 class="section-title">Add RPC To Existing Service</h2>
                <div id="rpc-alert-container"></div>
                <form id="add-rpc-form" class="space-y-2">
                    <div class="form-group">
                        <label for="rpc-service-name">Service Name *</label>
                        <select id="rpc-service-name" name="serviceName" required>
                            <option value="" disabled selected>Select a service</option>
                        </select>
                        <div class="help-text">Choose from existing services detected in proto/</div>
                    </div>
                    <div class="form-group">
                        <label for="rpc-name">RPC Name *</label>
                        <input type="text" id="rpc-name" name="rpcName" placeholder="e.g., SearchActions, UpsertAction" required>
                        <div class="help-text">PascalCase method name. First letter auto-capitalized.</div>
                    </div>
                    <div class="form-group">
                        <label for="rpc-req-fields">Request Fields *</label>
                        <textarea id="rpc-req-fields" name="reqFields" placeholder="query:string,limit:int32 or data:Action" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="rpc-res-fields">Response Fields *</label>
                        <textarea id="rpc-res-fields" name="resFields" placeholder="data:repeated Action or data:Action" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="rpc-http">HTTP Mapping *</label>
                        <input type="text" id="rpc-http" name="http" placeholder="GET:/v1/actions:search or PUT:/v1/actions/{data.id}" required>
                    </div>
                    <div class="form-group">
                        <label for="rpc-body">Body (optional)</label>
                        <input type="text" id="rpc-body" name="body" placeholder="* or data">
                    </div>

                    <div class="example">
                        <h4>📝 Examples:</h4>
                        <p><code>Service=Action, RPC=SearchActions, Req=query:string,limit:int32, Res=data:repeated Action, HTTP=GET:/v1/actions:search</code></p>
                        <p><code>Service=Order, RPC=UpsertOrder, Req=data:Order, Res=data:Order, HTTP=PUT:/v1/orders/{data.id}, Body=*</code></p>
                    </div>

                    <button type="submit" class="btn btn-primary">➕ Add RPC</button>
                </form>
            </div>

            <!-- Add Nested Type Section -->
            <div class="section" data-section="nested" style="display:none">
                <h2 class="section-title">Add Nested Message To Service</h2>
                <div id="nested-alert-container"></div>
                <form id="add-nested-form" class="space-y-2">
                    <div class="form-group">
                        <label for="nested-service-name">Service Name *</label>
                        <select id="nested-service-name" name="serviceName" required>
                            <option value="" disabled selected>Select a service</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nested-field-name">Field Name *</label>
                        <input type="text" id="nested-field-name" name="fieldName" placeholder="e.g., location" required>
                        <div class="help-text">snake_case recommended (stored as JSON/BSON tag)</div>
                    </div>
                    <div class="form-group">
                        <label for="nested-fields">Nested Fields *</label>
                        <textarea id="nested-fields" name="fields" placeholder="type:string,coordinates:repeated double" required></textarea>
                        <div class="help-text">Format: name:type (supports repeated and timestamp)</div>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="nested-repeated"> Repeated field</label>
                    </div>
                    <div class="form-group">
                        <label for="nested-message-name">Message Name (optional)</label>
                        <input type="text" id="nested-message-name" name="messageName" placeholder="e.g., Location (defaults to capitalized field name)">
                    </div>

                    <div class="example">
                        <h4>📝 Examples:</h4>
                        <p><code>Service=Place, Field=location, Fields=type:string,coordinates:repeated double</code></p>
                        <p><code>Service=Event, Field=occurred_at, Fields=tz:string,when:timestamp, Message=OccurredAt</code></p>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary">📦 Add Nested</button>
                        <button type="button" class="btn btn-secondary" onclick="prefillNestedExample()">Example</button>
                    </div>
                </form>
            </div>

            <!-- Existing Services Section -->
            <div class="section" data-section="existing" style="display:none">
                <h2 class="section-title">Existing Services</h2>
                <button class="btn btn-secondary" onclick="refreshServices()">🔄 Refresh Services</button>
                
                <div id="services-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading services...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="service-details-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Service Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-section">
                    <h4>Service Name</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Name:</strong> <span id="modal-service-name"></span>
                        </div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4>Files Created</h4>
                    <div class="code-block">
                        <div class="code-block-header">
                            <span class="code-block-title">proto</span>
                            <button class="copy-btn" onclick="copyText('proto/' + document.getElementById('modal-service-name').textContent.toLowerCase() + '.proto')">Copy</button>
                        </div>
                        <span id="modal-proto-path"></span>
                    </div>
                    <div class="code-block">
                        <div class="code-block-header">
                            <span class="code-block-title">services</span>
                            <button class="copy-btn" onclick="copyText('services/' + document.getElementById('modal-service-name').textContent.toLowerCase() + '.go')">Copy</button>
                        </div>
                        <span id="modal-services-path"></span>
                    </div>
                    <div class="code-block">
                        <div class="code-block-header">
                            <span class="code-block-title">models</span>
                            <button class="copy-btn" onclick="copyText('models/' + document.getElementById('modal-service-name').textContent.toLowerCase() + '.go')">Copy</button>
                        </div>
                        <span id="modal-models-path"></span>
                    </div>
                    <div class="code-block">
                        <div class="code-block-header">
                            <span class="code-block-title">pb</span>
                            <button class="copy-btn" onclick="copyText('pb/' + document.getElementById('modal-service-name').textContent.toLowerCase() + '.pb.go')">Copy</button>
                        </div>
                        <span id="modal-pb-path"></span>
                    </div>
                    <div class="code-block">
                        <div class="code-block-header">
                            <span class="code-block-title">pb (grpc)</span>
                            <button class="copy-btn" onclick="copyText('pb/' + document.getElementById('modal-service-name').textContent.toLowerCase() + '_grpc.pb.go')">Copy</button>
                        </div>
                        <span id="modal-pb-grpc-path"></span>
                    </div>
                    <div class="code-block">
                        <div class="code-block-header">
                            <span class="code-block-title">pb (gateway)</span>
                            <button class="copy-btn" onclick="copyText('pb/' + document.getElementById('modal-service-name').textContent.toLowerCase() + '.pb.gw.go')">Copy</button>
                        </div>
                        <span id="modal-pb-gw-path"></span>
                    </div>
                    <div class="code-block">
                        <div class="code-block-header">
                            <span class="code-block-title">swagger</span>
                            <button class="copy-btn" onclick="copyText('pb/' + document.getElementById('modal-service-name').textContent.toLowerCase() + '.swagger.json')">Copy</button>
                        </div>
                        <span id="modal-swagger-path"></span>
                    </div>
                </div>
                <div class="detail-section">
                    <h4>REST Endpoints</h4>
                    <ul class="endpoint-list">
                        <li class="endpoint-item">
                            <span class="endpoint-method post">POST</span>
                            <span class="endpoint-path">/v1/<span id="modal-rest-create-path"></span>s</span>
                            <button class="copy-btn" onclick="copyText('/v1/' + document.getElementById('modal-rest-create-path').textContent + 's')">Copy</button>
                        </li>
                        <li class="endpoint-item">
                            <span class="endpoint-method get">GET</span>
                            <span class="endpoint-path">/v1/<span id="modal-rest-list-path"></span>s/{id}</span>
                            <button class="copy-btn" onclick="copyText('/v1/' + document.getElementById('modal-rest-list-path').textContent + 's/{id}')">Copy</button>
                        </li>
                        <li class="endpoint-item">
                            <span class="endpoint-method put">PUT</span>
                            <span class="endpoint-path">/v1/<span id="modal-rest-update-path"></span>s/{id}</span>
                            <button class="copy-btn" onclick="copyText('/v1/' + document.getElementById('modal-rest-update-path').textContent + 's/{id}')">Copy</button>
                        </li>
                        <li class="endpoint-item">
                            <span class="endpoint-method delete">DELETE</span>
                            <span class="endpoint-path">/v1/<span id="modal-rest-delete-path"></span>s/{id}</span>
                            <button class="copy-btn" onclick="copyText('/v1/' + document.getElementById('modal-rest-delete-path').textContent + 's/{id}')">Copy</button>
                        </li>
                        <li class="endpoint-item">
                            <span class="endpoint-method get">GET</span>
                            <span class="endpoint-path">/v1/<span id="modal-rest-get-all-path"></span>s</span>
                            <button class="copy-btn" onclick="copyText('/v1/' + document.getElementById('modal-rest-get-all-path').textContent + 's')">Copy</button>
                        </li>
                    </ul>
                </div>
                <div class="detail-section">
                    <h4>Fields</h4>
                    <div id="modal-fields-container">
                        <!-- Fields will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let services = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadServices();
            setupEventListeners();
            setTab('create');
        });

        function setupEventListeners() {
            const form = document.getElementById('create-service-form');
            form.addEventListener('submit', handleCreateService);
            const rpcForm = document.getElementById('add-rpc-form');
            rpcForm.addEventListener('submit', handleAddRpc);
            const nestedForm = document.getElementById('add-nested-form');
            nestedForm.addEventListener('submit', handleAddNested);
            
            // Auto-capitalize service name
            const serviceNameInput = document.getElementById('service-name');
            serviceNameInput.addEventListener('input', function() {
                const value = this.value;
                if (value.length > 0 && value[0] !== value[0].toUpperCase()) {
                    this.value = value[0].toUpperCase() + value.slice(1);
                }
            });
            // service select populated after loading services
            const rpcNameInput = document.getElementById('rpc-name');
            rpcNameInput.addEventListener('input', function() {
                const value = this.value;
                if (value.length > 0 && value[0] !== value[0].toUpperCase()) {
                    this.value = value[0].toUpperCase() + value.slice(1);
                }
            });
        }

        // Normalize a single type token to standard proto naming
        function normalizeTypeToken(t) {
            if (!t) return t;
            const scalars = new Set([
                'string','bool','bytes','int32','int64','sint32','sint64','uint32','uint64',
                'fixed32','fixed64','sfixed32','sfixed64','float','double'
            ]);
            const tlc = t.toLowerCase();
            if (scalars.has(tlc)) return tlc;
            if (tlc === 'timestamp') return 'google.protobuf.Timestamp';
            if (tlc === 'google.protobuf.timestamp') return 'google.protobuf.Timestamp';
            // Custom message: PascalCase first letter
            return t[0].toUpperCase() + t.slice(1);
        }

        // Normalize full fields string: name:type pairs separated by commas
        function normalizeFieldsString(fieldsStr) {
            return fieldsStr
                .split(',')
                .map(pair => {
                    const raw = pair.trim();
                    if (!raw) return '';

                    // Case 1: name:type (type may start with 'repeated ')
                    if (raw.includes(':')) {
                        const nameRaw = raw.split(':')[0].trim();
                        let typeRaw = raw.split(':').slice(1).join(':').trim();
                        let isRepeated = false;
                        if (/^repeated\s+/i.test(typeRaw)) {
                            isRepeated = true;
                            typeRaw = typeRaw.replace(/^repeated\s+/i, '').trim();
                        }
                        const type = normalizeTypeToken(typeRaw);
                        return `${nameRaw}:${isRepeated ? 'repeated ' : ''}${type}`;
                    }

                    // Case 2: repeated type name
                    const m = raw.match(/^[Rr]epeated\s+([^\s]+)\s+([a-z][A-Za-z0-9_]*)$/);
                    if (m) {
                        const type = normalizeTypeToken(m[1]);
                        const name = m[2];
                        return `${name}:repeated ${type}`;
                    }

                    return raw; // leave untouched; server will validate
                })
                .filter(Boolean)
                .join(',');
        }

        // Parse inline nested syntax inside the create-service fields input.
        // Supports: field:{a:string,b:repeated int32} or field:repeated {a:string}
        // Returns { baseFields: string, nested: [{ fieldName, fields, repeated, messageName }] }
        function extractInlineNested(fieldsStr) {
            const segments = [];
            let buf = '';
            let depth = 0;
            for (let i = 0; i < fieldsStr.length; i++) {
                const ch = fieldsStr[i];
                if (ch === '{') depth++;
                if (ch === '}') depth--;
                if (ch === ',' && depth === 0) {
                    segments.push(buf.trim());
                    buf = '';
                } else {
                    buf += ch;
                }
            }
            if (buf.trim().length) segments.push(buf.trim());

            const nested = [];
            const base = [];

            for (const seg of segments) {
                // Match: name:repeated { ... } OR name:{ ... }
                const m = seg.match(/^([a-z][A-Za-z0-9_]*):\s*(repeated\s+)?\{([\s\S]*)\}$/);
                if (m) {
                    const fieldName = m[1];
                    const isRep = !!m[2];
                    const inner = m[3].trim();
                    // inner may include trailing/leading braces imbalance handled above
                    // Split inner respecting no nested braces (single level supported)
                    nested.push({ fieldName, fields: inner, repeated: isRep, messageName: '' });
                } else {
                    base.push(seg);
                }
            }

            return { baseFields: base.filter(Boolean).join(','), nested };
        }

        async function handleCreateService(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const serviceName = formData.get('serviceName').trim();
            const serviceFieldsRaw = formData.get('serviceFields').trim();

            // Extract inline nested definitions (field:{...}) and keep base fields
            const extracted = extractInlineNested(serviceFieldsRaw);
            const baseFieldsRaw = extracted.baseFields;

            if (!serviceName || !serviceFieldsRaw) {
                showAlert('Please fill in all required fields.', 'error');
                return;
            }

                    // Validate service name format
        if (!/^[A-Z][a-zA-Z0-9]*$/.test(serviceName)) {
            showAlert('Service name must be in PascalCase (e.g., User, ProductService). Please capitalize the first letter.', 'error');
            return;
        }

        

            // Normalize first so we can validate both repeated syntaxes
            const normalizedFields = normalizeFieldsString(baseFieldsRaw);
            // Validate fields format (allow 'repeated type')
            const fieldRegex = /^[a-z][a-zA-Z0-9_]*:(repeated\s+)?[a-zA-Z][a-zA-Z0-9._]*(\s*,\s*[a-z][a-zA-Z0-9_]*:(repeated\s+)?[a-zA-Z][a-zA-Z0-9._]*)*$/;
            if (!fieldRegex.test(normalizedFields)) {
                showAlert('Fields must be in format: fieldName:type,fieldName:type (e.g., name:string,email:string or occurred_at:google.protobuf.Timestamp). Repeated: favourites:repeated string or repeated string favourites', 'error');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        serviceName: serviceName,
                        serviceFields: normalizedFields
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(`Service "${serviceName}" created successfully!`, 'success');
                    // If there are inline nested definitions, create them now
                    for (const nest of extracted.nested) {
                        const nestFieldsNormalized = normalizeFieldsString(nest.fields);
                        const payload = {
                            serviceName,
                            fieldName: nest.fieldName,
                            fields: nestFieldsNormalized,
                            repeated: !!nest.repeated,
                            messageName: nest.messageName || ''
                        };
                        try {
                            const resp = await fetch('/api/nested', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            const rj = await resp.json();
                            if (resp.ok && rj.success) {
                                showAlert(`Nested "${nest.fieldName}" added to "${serviceName}".`, 'success');
                            } else {
                                showAlert(rj.error || `Failed to add nested "${nest.fieldName}".`, 'error');
                            }
                        } catch (e2) {
                            showAlert(`Network error adding nested "${nest.fieldName}": ${e2.message}`, 'error');
                        }
                    }
                    clearForm();
                    loadServices();
                } else {
                    showAlert(result.error || 'Failed to create service.', 'error');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadServices() {
            const container = document.getElementById('services-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading services...</p></div>';

            try {
                const response = await fetch('/api/services');
                const result = await response.json();

                if (response.ok) {
                    services = result.services || [];
                    renderServices();
                    populateServiceSelect();
                    populateNestedServiceSelect();
                } else {
                    showAlert(result.error || 'Failed to load services.', 'error');
                    container.innerHTML = '<p>Failed to load services.</p>';
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'error');
                container.innerHTML = '<p>Network error occurred.</p>';
            }
        }

        function populateServiceSelect() {
            const select = document.getElementById('rpc-service-name');
            if (!select) return;
            const current = select.value;
            // Reset options
            select.innerHTML = '<option value="" disabled selected>Select a service</option>';
            // Sort services alphabetically by name
            const sorted = [...services].sort((a, b) => a.name.localeCompare(b.name));
            sorted.forEach(svc => {
                const opt = document.createElement('option');
                opt.value = svc.name;
                opt.textContent = svc.name;
                select.appendChild(opt);
            });
            // Restore previous selection if still present
            if (current && sorted.find(s => s.name === current)) {
                select.value = current;
            }
        }

        function populateNestedServiceSelect() {
            const select = document.getElementById('nested-service-name');
            if (!select) return;
            const current = select.value;
            select.innerHTML = '<option value="" disabled selected>Select a service</option>';
            const sorted = [...services].sort((a, b) => a.name.localeCompare(b.name));
            sorted.forEach(svc => {
                const opt = document.createElement('option');
                opt.value = svc.name;
                opt.textContent = svc.name;
                select.appendChild(opt);
            });
            if (current && sorted.find(s => s.name === current)) {
                select.value = current;
            }
        }

        function renderServices() {
            const container = document.getElementById('services-container');
            
            if (services.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No services found</h3>
                        <p>Create your first service using the form above!</p>
                    </div>
                `;
                return;
            }

            const servicesHtml = services.map(service => `
                <div class="service-card">
                    <div class="service-name">${service.name}</div>
                    <div class="service-fields">
                        <strong>Fields:</strong> ${service.fields.join(', ')}
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-danger" onclick="removeService('${service.name}')">
                            🗑️ Remove Service
                        </button>
                        <button class="btn btn-secondary" onclick="viewServiceDetails('${service.name}')">
                            📋 View Details
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="services-grid">
                    ${servicesHtml}
                </div>
            `;
        }

        async function removeService(serviceName) {
            if (!confirm(`Are you sure you want to remove the "${serviceName}" service? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/services/${encodeURIComponent(serviceName)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(`Service "${serviceName}" removed successfully!`, 'success');
                    loadServices();
                } else {
                    showAlert(result.error || 'Failed to remove service.', 'error');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'error');
            }
        }

        function viewServiceDetails(serviceName) {
            const service = services.find(s => s.name === serviceName);
            if (!service) return;

            document.getElementById('modal-service-name').textContent = service.name;
            document.getElementById('modal-proto-path').textContent = `proto/${service.name.toLowerCase()}.proto`;
            document.getElementById('modal-services-path').textContent = `services/${service.name.toLowerCase()}.go`;
            document.getElementById('modal-models-path').textContent = `models/${service.name.toLowerCase()}.go`;
            document.getElementById('modal-pb-path').textContent = `pb/${service.name.toLowerCase()}.pb.go`;
            document.getElementById('modal-pb-grpc-path').textContent = `pb/${service.name.toLowerCase()}_grpc.pb.go`;
            document.getElementById('modal-pb-gw-path').textContent = `pb/${service.name.toLowerCase()}.pb.gw.go`;
            document.getElementById('modal-swagger-path').textContent = `pb/${service.name.toLowerCase()}.swagger.json`;

            document.getElementById('modal-rest-create-path').textContent = service.name.toLowerCase();
            document.getElementById('modal-rest-list-path').textContent = service.name.toLowerCase();
            document.getElementById('modal-rest-update-path').textContent = service.name.toLowerCase();
            document.getElementById('modal-rest-delete-path').textContent = service.name.toLowerCase();
            document.getElementById('modal-rest-get-all-path').textContent = service.name.toLowerCase();

            // Clear previous fields
            const fieldsContainer = document.getElementById('modal-fields-container');
            fieldsContainer.innerHTML = '';

            // Populate fields
            if (service.fields && Array.isArray(service.fields)) {
                service.fields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'detail-item';
                    fieldDiv.innerHTML = `
                        <strong>Field:</strong> <span>${field}</span>
                    `;
                    fieldsContainer.appendChild(fieldDiv);
                });
            } else {
                // Fallback: display as comma-separated string
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'detail-item';
                fieldDiv.innerHTML = `<strong>Fields:</strong> <span>${service.fields || 'No fields'}</span>`;
                fieldsContainer.appendChild(fieldDiv);
            }

            openModal();
        }

        function refreshServices() {
            loadServices();
        }

        function setTab(name) {
            const sections = document.querySelectorAll('[data-section]');
            sections.forEach(s => {
                s.style.display = (s.getAttribute('data-section') === name) ? 'block' : 'none';
            });
            const tabs = [
                { id: 'tab-create', key: 'create' },
                { id: 'tab-nested', key: 'nested' },
                { id: 'tab-rpc', key: 'rpc' },
                { id: 'tab-existing', key: 'existing' },
            ];
            tabs.forEach(t => {
                const el = document.getElementById(t.id);
                if (!el) return;
                if (t.key === name) {
                    el.classList.add('bg-gray-100');
                } else {
                    el.classList.remove('bg-gray-100');
                }
            });
            if (name === 'existing' || name === 'nested' || name === 'rpc') {
                loadServices();
            }
        }

        function clearForm() {
            document.getElementById('create-service-form').reset();
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showRpcAlert(message, type) {
            const container = document.getElementById('rpc-alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function showNestedAlert(message, type) {
            const container = document.getElementById('nested-alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        async function handleAddNested(e) {
            e.preventDefault();
            const serviceName = document.getElementById('nested-service-name').value;
            const fieldName = document.getElementById('nested-field-name').value.trim();
            const fields = normalizeFieldsString(document.getElementById('nested-fields').value.trim());
            const repeated = document.getElementById('nested-repeated').checked;
            const messageName = (document.getElementById('nested-message-name').value || '').trim();

            if (!serviceName || !fieldName || !fields) {
                showNestedAlert('Please fill in all required fields.', 'error');
                return;
            }
            if (!/^[a-z][a-zA-Z0-9_]*$/.test(fieldName)) {
                showNestedAlert('Field name must be snake_case or lowerCamel (start with a letter).', 'error');
                return;
            }

            // Retry logic: add-nested may run right after a fresh service is created; wait a bit and retry once
            const attempt = async () => {
                const resp = await fetch('/api/nested', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serviceName, fieldName, fields, repeated, messageName })
                });
                const result = await resp.json();
                return { ok: resp.ok && result.success, msg: result.error };
            };

            try {
                let r = await attempt();
                if (!r.ok) {
                    // brief delay then retry
                    await new Promise(res => setTimeout(res, 300));
                    r = await attempt();
                }
                if (r.ok) {
                    showNestedAlert('Nested message added successfully!', 'success');
                    e.target.reset();
                    loadServices();
                } else {
                    showNestedAlert(r.msg || 'Failed to add nested message.', 'error');
                }
            } catch (err) {
                showNestedAlert('Network error: ' + err.message, 'error');
            }
        }

        function prefillNestedExample() {
            const svc = document.getElementById('nested-service-name');
            if (svc && !svc.value && services.length) svc.value = services[0].name;
            document.getElementById('nested-field-name').value = 'location';
            document.getElementById('nested-fields').value = 'type:string,coordinates:repeated double';
            document.getElementById('nested-repeated').checked = false;
            document.getElementById('nested-message-name').value = 'Location';
            showNestedAlert('Example filled. Adjust and submit.', 'info');
        }

        // Add RPC with one retry (handles immediate use after service creation)
        async function handleAddRpc(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const serviceName = formData.get('serviceName').trim();
            const rpcName = formData.get('rpcName').trim();
            const reqFields = normalizeFieldsString(formData.get('reqFields').trim());
            const resFields = normalizeFieldsString(formData.get('resFields').trim());
            const http = formData.get('http').trim();
            const body = (formData.get('body') || '').trim();

            if (!serviceName || !rpcName || !reqFields || !resFields || !http) {
                showRpcAlert('Please fill in all required fields.', 'error');
                return;
            }
            if (!/^[A-Z][a-zA-Z0-9]*$/.test(serviceName)) {
                showRpcAlert('Service name must be PascalCase.', 'error');
                return;
            }
            if (!/^[A-Z][a-zA-Z0-9]*$/.test(rpcName)) {
                showRpcAlert('RPC name must be PascalCase.', 'error');
                return;
            }

            const attempt = async () => {
                const resp = await fetch('/api/rpc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serviceName, rpcName, reqFields, resFields, http, body })
                });
                const result = await resp.json();
                return { ok: resp.ok && result.success, msg: result.error };
            };

            try {
                let r = await attempt();
                if (!r.ok) {
                    await new Promise(res => setTimeout(res, 300));
                    r = await attempt();
                }
                if (r.ok) {
                    showRpcAlert(`RPC "${rpcName}" added to "${serviceName}" successfully!`, 'success');
                    e.target.reset();
                    loadServices();
                } else {
                    showRpcAlert(r.msg || 'Failed to add RPC.', 'error');
                }
            } catch (err) {
                showRpcAlert('Network error: ' + err.message, 'error');
            }
        }

        // Auto-refresh services every 30 seconds
        setInterval(loadServices, 30000);

        // Modal Functions
        function openModal() {
            document.getElementById('service-details-modal').style.display = 'block';
            // Add keyboard listener for Escape key
            document.addEventListener('keydown', handleKeyDown);
        }

        function closeModal() {
            document.getElementById('service-details-modal').style.display = 'none';
            // Remove keyboard listener
            document.removeEventListener('keydown', handleKeyDown);
        }

        function handleKeyDown(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        }

        // Close modal when clicking outside the modal
        window.onclick = function(event) {
            const modal = document.getElementById('service-details-modal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Copy text to clipboard
        function copyText(text) {
            navigator.clipboard.writeText(text).then(function() {
                const copyBtn = event.target;
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                const copyBtn = event.target;
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            });
        }
    </script>
</body>
</html> 